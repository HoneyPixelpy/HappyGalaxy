name: Django Tests
on:
  workflow_dispatch:  # Если хотите запускать вручную из GitHub UI
  # push:
  #   branches: [ main, multiservice/main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Docker
        uses: docker/setup-compose-action@v1
        with:
          version: 'latest'
          
      - name: Create .env file
        run: |
          # Все секреты доступны через
          cat > .env << EOF
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
          DEBUG=${{ secrets.DEBUG }}
          EOF
          
          echo "=== .env file created ==="
          ls -la .env
          echo "Lines in .env: $(wc -l < .env)"

      - name: Debug - Show non-sensitive env vars
        run: |
          echo "=== Checking .env (non-sensitive) ==="
          grep -E "^(ALLOWED_HOSTS|POSTGRES_HOST|POSTGRES_PORT|DEBUG|REDIS_URL)" .env || true

      - name: Start containers
        run: |
          docker compose --env-file .env up -d django analytic_consumer

          sleep 10

          echo "Waiting for PostgreSQL to be ready..."
          timeout 60s bash -c 'until docker compose exec postgres pg_isready -U ${POSTGRES_USER:-postgres}; do sleep 2; done'

          docker compose ps

      - name: Run Django migrations
        run: |
          # Применяем миграции для тестовой БД
          docker compose exec django python manage.py migrate --noinput

      - name: Run pytest in Django container
        run: |
          docker compose exec django pytest -v

      - name: Cleanup
        if: always()  # Выполнять даже если тесты упали
        run: |
          docker compose down -v
